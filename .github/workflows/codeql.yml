name: "CodeQL"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * *'

jobs:
  analyze:
    name: Analyze
    runs-on: ${{ matrix.os }}
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      matrix:
        os: [ "ubuntu-latest" ]
        java-version: [ 8, 11, 17 ]
        language: [ 'java', 'javascript' ]
        include:
          # 只对以下情况进行分析
          - os: "ubuntu-latest"
            java-version: 8
            language: 'java'
          - os: "ubuntu-latest"
            java-version: 11
            language: 'java'
          - os: "ubuntu-latest"
            java-version: 17
            language: 'java'
          - os: "ubuntu-latest"
            language: 'javascript'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v2
        with:
          java-version: ${{ matrix.java-version }}

      - name: Cache modules
        uses: actions/cache@v2
        id: cache-modules
        with:
          path: |
            ~/.m2/repository
            ~/.npm
            $GITHUB_WORKSPACE/passport-ui/node/
            $GITHUB_WORKSPACE/passport-ui/node_modules/
            $GITHUB_WORKSPACE/ui/node/
            $GITHUB_WORKSPACE/ui/node_modules/
          key: ${{ matrix.os }}-${{ hashFiles('pom.xml', '**/pom.xml', '**/**/pom.xml', '**/package.json') }}
          restore-keys: |
            ${{ matrix.os }}-

      - name: CI ENV
        id: date
        shell: sh
        run: |
          env
          echo $GITHUB_RUN_ID
          echo $GITHUB_JOB-${{ matrix.java-version }}
          echo "CI_PIPELINE_ID=$GITHUB_RUN_ID" >> $GITHUB_ENV
          echo "CI_JOB_ID=$GITHUB_JOB-${{ matrix.java-version }}" >> $GITHUB_ENV

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        # with:
          # language 和 java-version 需要删除
          #languages: ${{ matrix.language }}
          #java-version: ${{ matrix.java-version }}

      # Autobuild注释掉
      #- name: Autobuild
      #  uses: github/codeql-action/autobuild@v2

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
        with:
          category: "/"
