# 创建命名空间  ：kubectl create namespace xuxiaowei-cloud
# 创建 pod    ：kubectl apply -f nacos-deployment.yaml
# 查看 pod    ：kubectl -n xuxiaowei-cloud get pod -o wide
# 查看 pod    ：kubectl -n xuxiaowei-cloud get pod -o wide
# 进入 pod    ：kubectl -n xuxiaowei-cloud exec -it pod名称 bash
# 编辑 pod    ：kubectl -n xuxiaowei-cloud edit deployment nacos-deployment
# 删除 pod    ：kubectl -n xuxiaowei-cloud delete deployment nacos-deployment


# https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/
#
apiVersion: v1
kind: Secret
metadata:
  name: mysql-password
  namespace: xuxiaowei-cloud
type: Opaque
data:
  # xuxiaowei.com.cn 计算 base64 之后为 eHV4aWFvd2VpLmNvbS5jbg==
  password: eHV4aWFvd2VpLmNvbS5jbg==

---

# https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/deployment/
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nacos-deployment
  namespace: xuxiaowei-cloud
spec:
  selector:
    matchLabels:
      app: nacos
  # 此处使用一个副本（多副本服务可能无法注册）
  replicas: 1
  template:
    metadata:
      labels:
        app: nacos
    spec:
      containers:
        - name: nacos
          # https://hub.docker.com/r/nacos/nacos-server
          # [GitHub](https://github.com/alibaba/nacos/blob/develop/distribution/conf/nacos-mysql.sql)
          # [GitCode 镜像仓库](https://gitcode.net/mirrors/alibaba/nacos/-/blob/develop/distribution/conf/mysql-schema.sql)
          # [Gitee 镜像仓库](https://gitee.com/mirrors/Nacos/blob/develop/distribution/conf/mysql-schema.sql)
          image: nacos/nacos-server:v2.2.2
          env:
            - name: MODE
              value: standalone
            - name: SPRING_DATASOURCE_PLATFORM
              value: mysql
            - name: MYSQL_SERVICE_HOST
              # 使用 MySQL Service 名称
              value: mysql-service
            - name: MYSQL_SERVICE_PORT
              value: "3306"
            - name: MYSQL_SERVICE_DB_NAME
              value: nacos_config
            - name: MYSQL_SERVICE_DB_PARAM
              value: characterEncoding=utf8&connectTimeout=1000&socketTimeout=3000&autoReconnect=true&useSSL=false&allowPublicKeyRetrieval=true
            - name: MYSQL_SERVICE_USER
              value: root
            - name: NACOS_AUTH_TOKEN
              # 需要自行修改，否则有安全隐患，文档：https://nacos.io/zh-cn/docs/v2/guide/user/auth.html
              value: SecretKey012345678901234567890123456789012345678901234567890123456789
            - name: NACOS_AUTH_IDENTITY_KEY
              # 需要自行修改，否则有安全隐患，文档：https://nacos.io/zh-cn/docs/v2/guide/user/auth.html
              value: serverIdentity
            - name: NACOS_AUTH_IDENTITY_VALUE
              # 需要自行修改，否则有安全隐患，文档：https://nacos.io/zh-cn/docs/v2/guide/user/auth.html
              value: security
            - name: NACOS_AUTH_ENABLE
              # v2.2.2 之后，需要设置环境变量 NACOS_AUTH_ENABLE=true 才能开启鉴权
              # 开启鉴权后，微服务注册需要配置用户名、密码，配置参见各个服务的 bootstrap.yml 和 nacos 数据库的 SQL 脚本
              value: "true"
            - name: MYSQL_SERVICE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mysql-password
                  key: password
                  # 此值为默认值；意味着 "mysql-password" 必须存在且包含名为 "password" 的主键
                  optional: false
          ports:
            - containerPort: 8848
            - containerPort: 9848
          volumeMounts:
            # 时区
            - name: time-zone
              mountPath: /etc/localtime
      # https://kubernetes.io/zh-cn/docs/concepts/storage/volumes/
      volumes:
        # 时区
        - name: time-zone
          hostPath:
            path: /etc/localtime

---

# 创建 Service（不能指定 nodePort） ：kubectl -n xuxiaowei-cloud expose deployment nacos-deployment --type=NodePort --name=nacos-service
# 编辑 Service                    ：kubectl -n xuxiaowei-cloud edit service nacos-service
# 删除 Service                    ：kubectl -n xuxiaowei-cloud delete service nacos-service
# 查看 pod、Service               ：kubectl -n xuxiaowei-cloud get pod,svc -o wide

# https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/
apiVersion: v1
kind: Service
metadata:
  name: nacos-service
  namespace: xuxiaowei-cloud
spec:
  ports:
    - name: "8848"
      nodePort: 30848
      port: 8848
      protocol: TCP
      targetPort: 8848
    - name: "9848"
      nodePort: 31848
      port: 9848
      protocol: TCP
      targetPort: 9848
  selector:
    app: nacos
  type: NodePort
